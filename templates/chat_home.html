<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Chat</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/chat_style.css')}}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>


</head>

<body>
    <main class="content">
        <div class="container p-0">
            <div style="height: 100px;">
                <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" width="40"
                    height="40" style="margin-left: 2%;margin-top: 2%;">

                <h1 class="h3 mb-3" style="margin-left: 2%;" data-fromusername="{{login_user.username}}">{{
                    login_user.name }} {{message_count_dict}}</h1>
            </div>
            <div style="margin-left: 90%;margin-top: -3%;">
                <a href="/logout">
                    <h4>Log Out</h4>
                </a>
            </div>
            <br>


            <div class="row g-0"> <!--row starts-->
                <div class="col-12 col-lg-5 col-xl-3 border-right" style="height: 400px; overflow-y: auto;">
                    <div class="card">
                        {% for i in users %}

                        <a href="" class="list-group-item list-group-item-action border-0 user-item"
                            id="user-row-{{ i.username }}">

                            <div class="py-2 px-4 border-bottom d-none d-lg-block">
                                <div class="d-flex align-items-start" id="{{i.id}}" data-tousername="{{ i.username }}"
                                    data-name="{{i.name}}" style="margin-left: 2%;"
                                    onclick="return selectedUser(event)">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar3.png"
                                        class="rounded-circle mr-1" width="40" height="40">
                                    <div class="flex-grow-1 ml-3"
                                        style="font-weight: bold; margin-left: 2%;margin-top: 2%;">


                                        {{ i.name }}

                                        <span class="unread-messages-count badge bg-primary"></span>

                                    </div>
                                </div>
                            </div>
                        </a>

                        {% endfor %}
                    </div><!--card-->

                </div> <!--users column end-->

                <div class="col-12 col-lg-7 col-xl-9"> <!--message-->
                    <div class="card">
                        <div id="chat-screen" style="display: none;">


                            <div class="py-2 px-4 border-bottom d-none d-lg-block"><!--Message from user block-->
                                <div class="d-flex align-items-center py-1">
                                    <div class="position-relative">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar3.png"
                                            class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                                    </div>

                                    <div class="flex-grow-1 pl-3"> <!--Here the slected User's name displays-->
                                        <p id="name" style="margin-top: 1%;margin-left: 2%;font-weight: bold;"></p>
                                    </div>

                                </div>
                            </div><!--message from user block end-->

                            <div class="position-relative" style="height: 400px; overflow-y: auto;">
                                <!--message block starts-->
                                <div id="chat-room-widget"> <!--chat space-->
                                    <div id="msgs-container">
                                        <ul id="messages"></ul>
                                    </div>
                                </div> <!--Chat space end -->
                            </div> <!--message block end-->



                            <div class="flex-grow-0 py-3 px-4 border-top"> <!--button starts-->
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Type your message"
                                        name="message" id="message-input">
                                    <button class="btn btn-primary" type="submit" id="send-btn"
                                        onclick="sendMessage()">Send</button>
                                </div>
                            </div> <!--button ends-->
                        </div>

                        <div id="chat-screen-home"> <!--home screen-->
                            <div class="position-relative" style="height: 550px; overflow-y: auto;">
                                <!--message block starts-->
                                <div id="chat-room-widget"> <!--chat space-->
                                    <div
                                        style="margin-top: auto;margin-bottom: auto;font-size: 30px;text-align: center;color:rgb(10, 18, 102) ;">
                                        <img src="{{url_for('static',filename='images/chat_logo.jpg')}}" height="150px"
                                            width="150px" style="margin-top: 10%;"><br>

                                        Start Sending and Receiving your messages through Flask Chat

                                    </div>
                                </div> <!--Chat space end -->
                            </div> <!--message block end-->

                        </div><!--home screen div end-->

                    </div><!--card-->

                </div><!--message column end-->
            </div><!--row end-->

        </div><!--container end-->
    </main>

</body>

</html>

<script>
    var unread_data
    var toUsername = null
    document.addEventListener('DOMContentLoaded', function () {
        // Make a request to the login API endpoint
        fetch('getUnreadMessagesCount/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },

        })
            .then(response => response.json())
            .then(data => {
                // Handle the response data
                console.log(data);
                unread_data = data
                for (const [from_username, unread_messages_count] of Object.entries(data)) {
                    updateMessageNotification(from_username, unread_messages_count);
                }

                // data.forEach(user => {
                //     updateMessageNotification(user.from_username, user.unread_messages_count);
                // });

            })

    });

    function selectedUser(event) {
        event.preventDefault();
        // Access the id and data-username attributes
        var element = event.currentTarget;
        var id = element.getAttribute("id");
        var to_username = element.getAttribute("data-tousername");
        var name = element.getAttribute("data-name")
        toUsername = to_username;


        // Update the <p> element with the retrieved name value
        document.getElementById("name").textContent = name;


        fetch('getMessages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ "to_username": toUsername }),
        })
            .then(response => response.json())  // Assuming the response is JSON
            .then(all_messages => {
                var messagesContainer = document.getElementById("messages");
                messagesContainer.innerHTML = "";  // Clear existing messages

                all_messages.forEach(message => {
                    createChatItem(message);

                });

                document.getElementById("chat-screen").style.display = "block";
                scrollToLatestMessage();

                document.getElementById("chat-screen-home").style.display = "none";
            })


            fetch('mark_messages_as_read/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ "to_username": toUsername,"unread_data":unread_data}),
        })
            .then(response => response.json())  // Assuming the response is JSON
            .then(data => {
                // Handle the response data
                console.log(data);
                unread_data = data
                for (const [from_username, unread_messages_count] of Object.entries(data)) {
                    updateMessageNotification(from_username, unread_messages_count);
                }
                         

            })
            

        // // Emit an event to the server to mark messages as read
        // socketio.emit("mark_messages_as_read", { to_username: toUsername,unread_data:unread_data});

    }

    function updateMessageNotification(from_username, unread_messages_count) {
        console.log(from_username)
        console.log(unread_messages_count)
        var userRow = document.getElementById('user-row-' + from_username);

        if (userRow) {
            var unreadCountElement = userRow.querySelector('.unread-messages-count');

            if (unreadCountElement) {
                unreadCountElement.textContent = unread_messages_count;
                unreadCountElement.style.display = unread_messages_count > 0 ? 'inline-block' : 'none';
            }
        }
    }

    function scrollToLatestMessage() {
        var messagesContainer = document.getElementById("msgs-container");
        // Scroll to the bottom of the messages container
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
</script>

<script>
    var socketio = io();
    var from_username = document.querySelector('h1').getAttribute('data-fromusername');
    fromUsername = from_username
    console.log(fromUsername, "Main fromuser")

    // // Listen for the 'new_message_notification' event
    // socketio.on('new_message_notification', function (data) {
    //     // Update the UI with the updated unread messages count for the specified user
    //     updateMessageNotification(data.to_username, data.unread_messages_count);
    // });

    // // Listen for the read message  event
    // socketio.on('read_messages', function (data) {
    //     // Update the UI with the updated unread messages count for the specified user
    //     updateMessageNotification(data.to_username, data.unread_messages_count);
    // });


    socketio.on('message', function (message) {
        if (toUsername != null) {
            if ((message.from_user == fromUsername && message.to_user == toUsername) ||
                (message.from_user == toUsername && message.to_user == fromUsername)) {

                // Handle the received message 
                createChatItem(message);
                scrollToLatestMessage();
                if (message.self == false) {
                    console.log("entered in");
                    fetch('setStatus/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ "message_id": message.message_id }),
                    })
                        .then(response => response.json())
                } // Assuming the response is JSON

            }
            else {
                console.log(unread_data)
                console.log(message)
                keys = Object.keys(unread_data)
                console.log(keys)
                for (i = 0; i < keys.length; i++) {
                    if (keys[i] == message.from_user) {
                        unread_data[keys[i]] += 1
                        console.log(unread_data)
                        for (const [from_username, unread_messages_count] of Object.entries(unread_data)) {
                            updateMessageNotification(from_username, unread_messages_count);
                        }
                    }
                }


            }
        } else {
            console.log(unread_data, "unread")
            console.log("outer else case")
            keys = Object.keys(unread_data)
                console.log(keys)
                for (i = 0; i < keys.length; i++) {
                    if (keys[i] == message.from_user) {
                        unread_data[keys[i]] += 1
                        console.log(unread_data)
                        for (const [from_username, unread_messages_count] of Object.entries(unread_data)) {
                            updateMessageNotification(from_username, unread_messages_count);
                        }
                    }
                }
        }


    });



    function createChatItem(message) {
        var messages = document.getElementById("messages");
        var messageElement = document.createElement('li');
        var fromUsername = message.from_user;
        var text = message.content;
        var time = message.message_time;


        // Create a div to hold the message content, date, and time
        var messageContentDiv = document.createElement('div');
        messageContentDiv.textContent = text;

        // Create a span for the date and time
        var dateTimeSpan = document.createElement('span');
        dateTimeSpan.textContent = time;
        dateTimeSpan.style.fontSize = '10px'; // Adjust the font size as needed

        // Append the message content div to the message element
        messageElement.appendChild(messageContentDiv);
        messageElement.appendChild(dateTimeSpan);

        // Set different styles based on the sender
        if (fromUsername === document.querySelector('h1').getAttribute('data-fromusername')) {
            // Message from the logged-in user (align right)
            messageElement.style.textAlign = 'left';
            messageElement.style.marginLeft = 'auto'; // Align to the right
            messageElement.style.marginRight = '10px'; // Add some margin to separate messages
            messageElement.style.backgroundColor = '#DCF8C6'; // Light green background
        } else {
            // Message from another user (align left)
            messageElement.style.textAlign = 'left';
            messageElement.style.marginRight = 'auto'; // Align to the left
            messageElement.style.marginLeft = '10px'; // Add some margin to separate messages
            messageElement.style.backgroundColor = '#FFFFFF'; // white green background
        }

        // Apply a border to create a bubble-like styling
        messageElement.style.border = '1px solid #ddd';
        messageElement.style.borderRadius = '10px';
        messageElement.style.padding = '10px';
        messageElement.style.marginBottom = '10px';
        messageElement.style.width = '40%';
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
    }

    function sendMessage() {
        // Retrieve values
        const fromUsername = document.querySelector('h1').getAttribute('data-fromusername');
        const msgInput = document.getElementById('message-input');

        if (msgInput.value === "") return;

        var msg = msgInput.value;
        socketio.emit("message", {
            'message': msg,
            'from_username': fromUsername,
            'to_username': toUsername
        });
        msgInput.value = "";
    }

    // Add an event listener for click on the "Send" button
    document.getElementById('send-btn').addEventListener('click', function () {
        sendMessage();
    });

    // Add an event listener for key press on the message input
    document.getElementById('message-input').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });
</script>