<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flask Chat</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/chat_style.css')}}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
        integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
        crossorigin="anonymous"></script>


</head>

<body>
    <main class="content">
        <div class="container p-0">
            <div style="height: 100px;">
                <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" width="40"
                    height="40" style="margin-left: 2%;margin-top: 2%;">

                <h1 class="h3 mb-3" style="margin-left: 2%;" data-fromusername="{{login_user.username}}">{{
                    login_user.name }}</h1>
            </div>
            <div style="margin-left: 90%;margin-top: -3%;">
                <a href="/logout">
                    <h4>Log Out</h4>
                </a>
            </div>
            <br>


            <div class="row g-0"> <!--row starts-->
                <div class="col-12 col-lg-5 col-xl-3 border-right" style="height: 400px; overflow-y: auto;"> 
                    <div class="card">
                        {% for i in users %}
                        <a href="" class="list-group-item list-group-item-action border-0 user-item">
                            <div class="py-2 px-4 border-bottom d-none d-lg-block">
                                <div class="d-flex align-items-start" id="{{i.id}}" data-tousername="{{ i.username }}"
                                    data-name="{{i.name}}" style="margin-left: 2%;"
                                    onclick="return selectedUser(event)">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar3.png"
                                        class="rounded-circle mr-1" width="40" height="40">
                                    <div class="flex-grow-1 ml-3"
                                        style="font-weight: bold; margin-left: 2%;margin-top: 2%;">

                                        {{ i.name }}


                                    </div>
                                </div>
                            </div>
                        </a>

                        {% endfor %}
                    </div><!--card-->

                </div> <!--users column end-->

                <div class="col-12 col-lg-7 col-xl-9"> <!--message-->
                    <div class="card">
                        <div id="chat-screen" style="display: none;">
                            

                        <div class="py-2 px-4 border-bottom d-none d-lg-block"><!--Message from user block-->
                            <div class="d-flex align-items-center py-1">
                                <div class="position-relative">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar3.png"
                                        class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                                </div>
                                <div class="flex-grow-1 pl-3">
                                    <p id="name" style="margin-top: 1%;margin-left: 2%;font-weight: bold;"></p>


                                </div>

                            </div>
                        </div><!--message from user block end-->

                        <div class="position-relative" style="height: 400px; overflow-y: auto;"> <!--message block starts-->
                            <div id="chat-room-widget"> <!--chat space-->
                                <div id="msgs-container">
                                    <ul id="messages"></ul>
                                </div>
                            </div>      <!--Chat space end -->                            
                        </div>          <!--message block end-->
                        


                        <div class="flex-grow-0 py-3 px-4 border-top">  <!--button starts-->
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Type your message"
                                    name="message" id="message-input">
                                <button class="btn btn-primary" type="submit" id="send-btn"
                                    onclick="sendMessage()">Send</button>
                            </div>
                        </div>          <!--button ends-->
                        </div>

                        <div id="chat-screen-home"> <!--home screen-->
                            <div class="position-relative" style="height: 550px; overflow-y: auto;"> <!--message block starts-->
                                <div id="chat-room-widget"> <!--chat space-->
                                    <div style="margin-top: auto;margin-bottom: auto;font-size: 30px;text-align: center;color:rgb(10, 18, 102) ;">
                                        <img src="{{url_for('static',filename='images/chat_logo.jpg')}}" height="150px" width="150px" style="margin-top: 10%;"><br>

                                        Start Sending and Receiving your messages through Flask Chat
                                        
                                    </div>
                                </div>      <!--Chat space end -->                            
                            </div> <!--message block end-->

                        </div><!--home screen div end-->

                    </div><!--card-->

                </div><!--message column end-->
            </div><!--row end-->

        </div><!--container end-->
    </main>
</body>

</html>
<script>
    function selectedUser(event) {
        event.preventDefault();
        // Access the id and data-username attributes
        var element = event.currentTarget;
        var id = element.getAttribute("id");
        var to_username = element.getAttribute("data-tousername");
        var name = element.getAttribute("data-name")
        console.log(id)
        console.log(to_username)

        toUsername = to_username;

        // Update the <p> element with the retrieved name value
        document.getElementById("name").textContent = name;

        // Clear existing messages
        // var messagesContainer = document.getElementById("messages");
        //  messagesContainer.innerHTML = "";
      

//         fetch(
//             'getMessages/'+to_username,
//             {
//                 method: 'POST',
//             },
//             JSON.stringify({"to_username":toUsername})
//         ).then(response => {
//             let all_messages = response
//             var messagesContainer = document.getElementById("messages");
//             messagesContainer.innerHTML = "";  // Clear existing messages
//             all_messages.forEach(message => {
//             createChatItem(message);
//         });
            
// });

fetch('getMessages/' + to_username, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({ "to_username": toUsername }),
})
    .then(response => response.json())  // Assuming the response is JSON
    .then(all_messages => {
        var messagesContainer = document.getElementById("messages");
        messagesContainer.innerHTML = "";  // Clear existing messages

        all_messages.forEach(message => {
            createChatItem(message);
            scrollToLatestMessage();
        });
        document.getElementById("chat-screen").style.display = "block";
        document.getElementById("chat-screen-home").style.display = "none";
    })
   

    }

    function scrollToLatestMessage() {
    var messagesContainer = document.getElementById("msgs-container");
    
    // Scroll to the bottom of the messages container
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
</script>

<script>
    var socketio = io();

      function createChatItem(message) {
      var messages = document.getElementById("messages");
      var messageElement = document.createElement('li');
      var fromUsername = message.from_user;
      var text = message.content;
      var time=message.message_time;
      console.log(time)

    // Create a text node with the message
    // var messageNode = document.createTextNode(text);
    // messageElement.appendChild(messageNode);    
    // messages.appendChild(messageElement);
    // messages.scrollTop = messages.scrollHeight;

     // Create a div to hold the message content, date, and time
     var messageContentDiv = document.createElement('div');
    messageContentDiv.textContent = text;

    // Create a span for the date and time
    var dateTimeSpan = document.createElement('span');
    dateTimeSpan.textContent = time; // Assuming you have a function to format date and time
    dateTimeSpan.style.fontSize = '10px'; // Adjust the font size as needed

     

    // Append the message content div to the message element
    messageElement.appendChild(messageContentDiv);
    messageElement.appendChild(dateTimeSpan);

    // Set different styles based on the sender
    if (fromUsername === document.querySelector('h1').getAttribute('data-fromusername')) {
        // Message from the logged-in user (align right)
        messageElement.style.textAlign = 'left';
        messageElement.style.marginLeft = 'auto'; // Align to the right
        messageElement.style.marginRight = '10px'; // Add some margin to separate messages
        messageElement.style.backgroundColor = '#DCF8C6'; // Light green background
    } else {
        // Message from another user (align left)
        messageElement.style.textAlign = 'left';
        messageElement.style.marginRight = 'auto'; // Align to the left
        messageElement.style.marginLeft = '10px'; // Add some margin to separate messages
        messageElement.style.backgroundColor = '#FFFFFF'; // white green background
    }

    // Apply a border to create a bubble-like styling
    messageElement.style.border = '1px solid #ddd';
    messageElement.style.borderRadius = '10px';
    messageElement.style.padding = '10px';
    messageElement.style.marginBottom = '10px';
    messageElement.style.width='40%';

    messages.appendChild(messageElement);
    messages.scrollTop = messages.scrollHeight;

     
    }

//     function formatDateTime(timestamp) {
//     // Convert the timestamp to a Date object
//     const date = new Date(timestamp);

//     // Format the date without the timezone information
//     const formattedDate = date.toLocaleString('en-IN', {
//         day: '2-digit',
//         month: '2-digit',
//         year: 'numeric',
//         hour: '2-digit',
//         minute: '2-digit',
//         second: '2-digit',
//         hour12: true,
//         timeZone: 'UTC'  // Set timeZone to UTC to remove the timezone offset
//     });

//     return formattedDate;
// }
    

    function sendMessage() {
        // Retrieve values
        const fromUsername = document.querySelector('h1').getAttribute('data-fromusername');
        const msgInput = document.getElementById('message-input');
        

        // Do something with the values (for example, logging to the console)
        console.log('From:', fromUsername);
        console.log('To:', toUsername);
        console.log('Message:', msgInput.value);

        if (msgInput.value === "") return;
        var msg = msgInput.value;
        

         // Display the sent message in the chat window
    createChatItem({ 'content': msg ,
    'from_user': fromUsername,
    'message_time':new Date()});
    scrollToLatestMessage();

        socketio.emit("message", {
            'message': msg,
            'from_username': fromUsername,
            'to_username': toUsername
        });
        msgInput.value = "";

    }
</script>